# syntax=docker/dockerfile:1.6

###########
# Server build (NestJS)
###########
FROM node:22-alpine AS server-deps
WORKDIR /usr/src/app

# Install dependencies with cache (includes dev deps for runtime migrations)
COPY package.json yarn.lock ./
COPY patches ./patches
RUN --mount=type=cache,target=/root/.cache/yarn \
    yarn install --frozen-lockfile

FROM node:22-alpine AS server-build
WORKDIR /usr/src/app
COPY --from=server-deps /usr/src/app/node_modules ./node_modules
COPY . .
# Cache tsc incremental files between builds
RUN --mount=type=cache,target=/root/.cache/yarn \
    --mount=type=cache,target=/usr/src/app/.tsbuildcache \
    yarn build

###########
# Multi-tenancy proxy deps
###########
FROM node:22-alpine AS proxy-deps
WORKDIR /usr/src/proxy
COPY multi-tenancy/package.json multi-tenancy/yarn.lock ./
RUN --mount=type=cache,target=/root/.cache/yarn \
    yarn install --frozen-lockfile --production

###########
# Runtime image
###########
FROM node:22-alpine AS runner

# Locale & timezone
RUN apk add --no-cache tzdata curl \ 
    && cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \ 
    && echo "Asia/Shanghai" > /etc/timezone

ENV NODE_ENV=production \
    NODE_OPTIONS=--max_old_space_size=4096 \
    MONKEYS_DIST_FOLDER=/usr/src/server/dist \
    TZ=Asia/Shanghai \
    LC_ALL=en_US.UTF-8 \
    LANG=en_US.UTF-8 \
    LANGUAGE=en_US.UTF-8

# Server runtime (keep full node_modules because migrations use dev tools like ts-node)
WORKDIR /usr/src/server
COPY --from=server-build /usr/src/app/dist ./dist
COPY --from=server-deps /usr/src/app/node_modules ./node_modules
COPY --from=server-build /usr/src/app/ormconfig.js ./ormconfig.js
COPY --from=server-build /usr/src/app/package.json ./package.json

# Proxy runtime
WORKDIR /usr/src/proxy
COPY multi-tenancy/. .
COPY --from=proxy-deps /usr/src/proxy/node_modules ./node_modules

EXPOSE 3000
CMD ["node", "main.js"]
