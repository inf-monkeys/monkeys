import { MonkeyToolCategories, MonkeyToolDisplayName, MonkeyToolIcon, MonkeyToolInput, MonkeyToolName, MonkeyToolOutput } from '@/common/decorators/monkey-block-api-extensions.decorator';
import { IRequest } from '@/common/typings/request';
import { ApiType, AuthType, ManifestJson, SchemaVersion } from '@/common/typings/tools';
import { Body, Controller, Get, Post, Req } from '@nestjs/common';
import { ApiExcludeEndpoint, ApiTags } from '@nestjs/swagger';
import { ComfyUIService } from './comfyui.service';
import { COMFYUI_TOOL_OPENAPI_PATH } from './comfyui.swagger';
import { RunComfyuiWorkflowDto } from './dto/req/execute-comfyui-workflow';

export const COMFYUI_NAMESPACE = 'comfyui';
export const COMFYUI_TOOL = 'run_comfyui_workflow';

@Controller('/comfyui/')
@ApiTags('ComfyUI')
export class ComfyuiExecutionController {
  constructor(private readonly comfyuiService: ComfyUIService) {}

  @Get('/manifest.json')
  @ApiExcludeEndpoint()
  public getMetadata(): ManifestJson {
    return {
      schema_version: SchemaVersion.v1,
      display_name: 'ComfyUI',
      namespace: COMFYUI_NAMESPACE,
      auth: {
        type: AuthType.none,
      },
      api: {
        type: ApiType.openapi,
        url: `${COMFYUI_TOOL_OPENAPI_PATH}-json`,
      },
      contact_email: 'dev@inf-monkeys.com',
    };
  }

  @Post('/')
  @MonkeyToolName(COMFYUI_TOOL)
  @MonkeyToolDisplayName({
    'zh-CN': 'è¿è¡Œ ComfyUI å·¥ä½œæµ',
    'en-US': 'Run ComfyUI Workflow',
  })
  @MonkeyToolCategories(['gen-image'])
  @MonkeyToolIcon('emoji:ğŸ–Œï¸:#98ae36')
  @MonkeyToolInput([
    {
      displayName: 'ComfyUI Server',
      name: 'server',
      type: 'string',
      required: true,
      typeOptions: { assetType: 'comfyui-server' },
    },
    {
      displayName: {
        'zh-CN': 'å·¥ä½œæµ',
        'en-US': 'Workflow',
      },
      name: 'workflow',
      type: 'string',
      required: true,
      typeOptions: { assetType: 'comfyui-workflow' },
    },
    {
      displayName: {
        'zh-CN': 'ç§»é™¤ ComfyUI å·¥ä½œæµåµŒå…¥',
        'en-US': 'Remove workflow from images generated by ComfyUI.',
      },
      name: 'removePrompt',
      type: 'boolean',
      description: {
        'zh-CN': 'è‡ªåŠ¨å°† ComfyUI ç”Ÿæˆçš„å›¾ç‰‡ä¸­å»é™¤æç¤ºè¯ç­‰ä¿¡æ¯',
        'en-US': 'Automatically remove prompt and workflow from images generated by ComfyUI.',
      },
      required: true,
      default: false,
    },
    {
      displayName: {
        'zh-CN': 'å›¾ç‰‡åµŒå…¥å·¥ä½œæµæ‰§è¡Œé…ç½®',
        'en-US': 'Embed workflow execution settings into images',
      },
      name: 'addMonkeyInput',
      type: 'boolean',
      description: {
        'zh-CN': 'è‡ªåŠ¨å‘ ComfyUI ç”Ÿæˆçš„å›¾ç‰‡ä¸­åµŒå…¥å·¥ä½œæµçš„æ‰§è¡Œé…ç½®ï¼ˆmonkey_inputï¼‰',
        'en-US': 'Automatically embed workflow execution settings (monkey_input) into images generated by ComfyUI.',
      },
      required: true,
      default: true,
    },
  ])
  @MonkeyToolOutput([
    {
      name: 'file_list',
      displayName: {
        'zh-CN': 'æ–‡ä»¶è¾“å‡ºåˆ—è¡¨',
        'en-US': 'File Output List',
      },
      type: 'string',
      typeOptions: {
        multipleValues: true,
      },
    },
    {
      name: 'text_output',
      displayName: {
        'zh-CN': 'æ–‡æœ¬è¾“å‡ºåˆ—è¡¨',
        'en-US': 'Text Output List',
      },
      type: 'string',
      typeOptions: {
        multipleValues: true,
      },
    },
  ])
  public async runComfyuiWorkflow(@Req() req: IRequest, @Body() body: RunComfyuiWorkflowDto) {
    const { workflow, server, removePrompt, addMonkeyInput, ...rest } = body;
    const inputInfo = addMonkeyInput
      ? {
          instanceId: req.headers['x-monkeys-workflow-instanceid'] as string | undefined,
          teamId: req.headers['x-monkeys-teamid'] as string | undefined,
          addMonkeyInput: true,
        }
      : {};
    return await this.comfyuiService.runComfyuiWorkflow(server, workflow, rest, {
      removePrompt,
      addMonkeyInput: false,
      ...inputInfo,
    });
  }
}
